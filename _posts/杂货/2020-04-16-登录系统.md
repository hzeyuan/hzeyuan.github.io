---
layout: post
title: "登录系统设计"
subtitle: '登录系统设计'
author: "Hzy"
header-style: text
tags:
  - 登录系统设计
---



##### 2.4 前后端的鉴权方式设计。

> 常见的几种鉴权方式

* HTTP Basic Authentication
* session-cookie
* Token 验证
* OAuth(开放授权)

>这里我们选用Token验证，常用的JWT。

Token验证的好处：

* 相比在服务端效验sessionID的有效性，TOken本身就是一种登录凭证，需要效验是否合法即可。
* 相比cookies-session,Token验证支持更多的客户端类型。
* 更易于扩展。

##### 2.4.1 Jwt验证会遇到的几个问题：

>废除问题：

* Token一定签发了，在有效期内都可以使用，服务端无法终止和废除。
>续签问题：
* 无法像session那样， 自动更新sessionID的有效期。


解决方法是：参考OAuth2中个的refreshToken，允许客户端主动刷新`Access Token`

![jwt流程](/img/jwt流程.jpg)


>流程：

* 客户端首先进行认证。
* 服务端效验后 ，生成两个Token:Access Token 和Refresh Token，一个有效期短，一个有效期长。
* 客户端访问受限资源时，携带access Token，进行鉴权。
* 如果Access Token 没有过期，则返回数据。
* 如果Access Token 过期，通知客户端使用Refresh请求刷新接口，刷新accessToken。
* 如果Refresh Token 没有过期，服务端下方新的Access Token，客户端通过新的Access Token 请求数据。
* 如果Refresh Token 过期，同时access Token也过期，那么让用户重新登录。

>这样的好处在于，用户不会频繁的隔几个小时就需要登录一次，但Refresh Token有效时长是固定的，假设是两周，那么用户两周就需要登录一次。



> 对Refresh Token的改进

* 可以在用每次请求更换Access Token时，判断Refresh Token的剩余时长,若小于25%，则延长一个Access TOken的时间。



> 如何同一时间，允许在一个设备登录？

* 我们在缓存中维护一个黑名单表，同时jti是每个token的唯一标识符。
* 新设备登录时，更换Token的时候把旧的Token加入到黑名单中。
* 旧的token请求时，由于在黑名单表中，判定为无效。

>定时清理黑名单中过期的Token，防止缓存表太大。




### 参考文章

* [前后端常见的几种鉴权方式(小结)](https://www.jb51.net/article/166889.htm)
* [基于 JWT + Refresh Token 的用户认证实践](https://zhuanlan.zhihu.com/p/52300092)
* [设计一个可扩展的用户登录系统 (1)](https://www.liaoxuefeng.com/article/1029274073038464)
* [设计一个可扩展的用户登录系统 (2)](https://www.liaoxuefeng.com/article/1078848528483840)
* [设计一个可扩展的用户登录系统 (3)](https://www.liaoxuefeng.com/article/1079209877054048)
* [JSON Web Token 入门教程](https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)